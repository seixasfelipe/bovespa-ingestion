#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)
require 'historical_quotes'

module HistoricoAtivos

  if ARGV.size <= 0

    puts "Bovespa Ingestion allows you to import historical BM&F Bovespa stock exchange rates"
    puts "  Use: "
    puts "      load_history command [arguments...]"
    puts ""
    puts "  Examples:"
    puts "      load_history install"
    puts "      load_history import sample/sample_cota_hist_2003.txt"
    puts ""
    puts "  For more informations:"
    puts "      https://github.com/seixasfelipe/bovespa-ingestion"

  else

    command = ARGV[0]
  
    if command == 'install'
      require 'rake'
      StandaloneMigrations::Tasks.load_tasks

      migrate_path = File.expand_path("../../db/migrate", __FILE__)
      paths = Rails.application.config.paths
      paths.add "db/migrate", :with => migrate_path
      
      Rake::Task['db:migrate'].invoke
      # system("rake db:migrate")
    elsif command == 'import'

      if ARGV.size == 1
        puts "Please specify the file."
      else

        sample_file = ARGV[1]

        puts "Loading historical data file: #{sample_file}"

        start_time = Time.now

        loader = CarregaHistorico.new ParserHeader.new, ParserTrailer.new, ParserStockQuote.new
        historical_quotes = loader.load sample_file 

        puts "Total stock quotes loaded: #{historical_quotes.stock_quotes.length}."

        loader.persist historical_quotes

        end_time = Time.now 
        elapsed_time = (end_time - start_time) * 1000.0

        puts "Historical data loaded in #{elapsed_time} ms!"
      end
    
    end

  end

end